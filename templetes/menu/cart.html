{% extends 'base.html' %}
{% block content %}
<h1>Your Cart</h1>
{% if cart_items %}
<table>
    <tr>
        <th>Item</th>
        <th>Price</th>
        <th>Quantity</th>
        <th>Subtotal</th>
        <th>Action</th>
    </tr>
    {% for item in cart_items %}
    <tr id="cart-item-{{ item.id }}">
        <td>{{ item.menu_item.name }}</td>
        <td>{{ item.menu_item.price }}</td>
        <td>
            <button class="decrement" data-id="{{ item.id }}">-</button>
            <span class="quantity">{{ item.quantity }}</span>
            <button class="increment" data-id="{{ item.id }}">+</button>
        </td>
        <td class="subtotal">{{ item.subtotal }}</td>
        <td><button class="remove" data-id="{{ item.id }}">Remove</button></td>
    </tr>
    {% endfor %}
</table>
<p>Total: <span id="total">{{ total }}</span></p>
<a href="{% url 'menu:checkout' %}">Checkout</a>
{% else %}
<p>Your cart is empty.</p>
{% endif %}
<a href="{% url 'menu:menu' %}">Back to Menu</a>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function(){
    function recalcTotal(){
        let total = 0;
        $('td.subtotal').each(function(){
            total += parseFloat($(this).text());
        });
        $('#total').text(total.toFixed(2));
    }

    $('.increment').click(function(){
        let id = $(this).data('id');
        $.get("{% url 'menu:update_cart_item' 0 %}".replace('0', id) + '?action=increment', function(data){
            if(data.success){
                let row = $('#cart-item-' + id);
                row.find('.quantity').text(data.quantity);
                row.find('.subtotal').text(data.subtotal.toFixed(2));
                recalcTotal();
            }
        });
    });

    $('.decrement').click(function(){
        let id = $(this).data('id');
        $.get("{% url 'menu:update_cart_item' 0 %}".replace('0', id) + '?action=decrement', function(data){
            if(data.success){
                let row = $('#cart-item-' + id);
                row.find('.quantity').text(data.quantity);
                row.find('.subtotal').text(data.subtotal.toFixed(2));
                recalcTotal();
            }
        });
    });

    $('.remove').click(function(){
        let id = $(this).data('id');
        $.get("{% url 'menu:update_cart_item' 0 %}".replace('0', id) + '?action=remove', function(data){
            if(data.success && data.removed){
                $('#cart-item-' + id).remove();
                recalcTotal();
            }
        });
    });
});
</script>
{% endblock %}
